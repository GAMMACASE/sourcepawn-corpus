#include <sourcemod>

#pragma semicolon 1
#pragma newdecls required

public Plugin myinfo =
{
	name = "[CSGO] Server Lag Exploit Fix [3/7/2020]",
	author = "backwards, Kellan123",
	description = "Fixes an exploit attackers can use to cause the server to stutter.",
	version = SOURCEMOD_VERSION,
	url = "http://www.steamcommunity.com/id/mypassword"
}

public void OnPluginStart()
{
	Address addy = GameConfGetAddress(LoadGameConfigFile("LagExploitFix_3_7_2020"), "InvalidReliableState");

	if (GetEngineVersion() == Engine_CSGO)
	{
		int OS = LoadFromAddress(addy + view_as<Address>(1), NumberType_Int8);
		switch(OS)
		{
			case 0x89: //Linux
			{
				//Force Client Exploit To Happen
				//StoreToAddress((addy + view_as<Address>(0x3F3)), 0x87, NumberType_Int8);	
			
				//Patch Exploit
				for(int i = 0;i<36;i++)
					StoreToAddress((addy + view_as<Address>(0x9E8) + view_as<Address>(i)), 0x90, NumberType_Int8);
			}
			case 0x8B: //Windows
			{
				//Force Client Exploit To Happen
				//StoreToAddress((addy + view_as<Address>(0x731)), 0x87, NumberType_Int8);	
				
				//Patch Exploit
				for(int i = 0;i<28;i++)
					StoreToAddress((addy + view_as<Address>(0x85F) + view_as<Address>(i)), 0x90, NumberType_Int8);
			}
			default:
			{
				SetFailState("InvalidReliableState Signature Incorrect. (0x%.2x)", OS);
			}
		}
	}
}