/* Plugin Template generated by Pawn Studio */

#pragma semicolon 1
#pragma newdecls required
#include <sourcemod>
#include <sdktools>
#include <sdktools_functions>

#define ZOMBIECLASS_SURVIVOR	9
#define ZOMBIECLASS_SMOKER	1
#define ZOMBIECLASS_BOOMER	2
#define ZOMBIECLASS_HUNTER	3
#define ZOMBIECLASS_SPITTER	4
#define ZOMBIECLASS_JOCKEY	5
#define ZOMBIECLASS_CHARGER	6
int ZOMBIECLASS_TANK = 5;

int GameMode;
int L4D2Version;

bool Debug = false;
/* 
* 
* some code from "L4D2 Monster Bots",	author = "Machine"
* 
*/
public Plugin myinfo = 
{
	name = "Automatic Difficult Balance base on intensity",
	author = "Pan Xiaohai && Zakikun",
	description = "Auto adjust difficulty base on Director's intensity measure",
	version = "1.4",
	url = "wyxls123@gmail.com"
}

bool ShowHud[MAXPLAYERS+1];
 
int CurrentAverage; 

int PlayerIntensity[MAXPLAYERS+1];
int PlayerTotalIntensity[MAXPLAYERS+1];
int PlayerTick[MAXPLAYERS+1];

bool NeedDrawHud = false;
bool HaveTank = false;

int AllTotalIntensity;
int AllTotalTick=1; 

int CiCount;
int SiCount;
int SurvivorCount;

int MobTick;

int MaxSpecial;
int MaxCommon;

int AdustTick;
int DirectorStopTick;
bool DirectorStoped;
bool LeftSafeRoom;

Handle l4d_balance_difficulty_min;
Handle l4d_balance_difficulty_max;

Handle l4d_balance_enable; 
Handle l4d_balance_reaction_time; 
Handle l4d_balance_setting_password; 

Handle l4d_balance_include_bot;
Handle l4d_balance_include_zombie;
Handle l4d_balance_include_witch;

Handle l4d_balance_health_increment; 
Handle l4d_balance_health_witch;
Handle l4d_balance_health_tank; 
Handle l4d_balance_health_hunter;
Handle l4d_balance_health_smoker; 
Handle l4d_balance_health_boomer;
Handle l4d_balance_health_charger; 
Handle l4d_balance_health_jockey; 
Handle l4d_balance_health_spitter; 
Handle l4d_balance_health_zombie; 

Handle l4d_balance_limit_special; 
Handle l4d_balance_limit_special_add; 
Handle l4d_balance_limit_common;
Handle l4d_balance_limit_common_add;
Handle hTimerAjust;
Handle hPlayerLeftStart;
Handle hTimerUpdatePlayer;
Handle hTimerShowHUD;

public void OnPluginStart()
{
	GameCheck(); 	
	if(GameMode != 1) return;
	l4d_balance_enable = 			CreateConVar("l4d_balance_enable", "1", "0:关闭, 1:开启");
	l4d_balance_reaction_time = 	CreateConVar("l4d_balance_reaction_time", "30", "平衡系统反应调节难度时长(秒) [10, 60]"); 
	
	l4d_balance_difficulty_min = 	CreateConVar("l4d_balance_difficulty_min", "25", "最低难度, 如果生还者危险系数低于该值则会启动平衡 [0, 100]");
	l4d_balance_difficulty_max = 	CreateConVar("l4d_balance_difficulty_max", "99", "最高难度, 如果生还者危险系数高于该值则会关闭平衡 [0, 100]");	
	l4d_balance_include_bot = 	 	CreateConVar("l4d_balance_include_bot", "0", "是否将生还者BOT计算在内 0: 忽略生还者BOT , 1:包括生还者BOT"); 
	l4d_balance_include_zombie=		CreateConVar("l4d_balance_include_zombie", "0", "是否考虑增加普通僵尸HP 0: 否 , 1:是"); 
	l4d_balance_include_witch=		CreateConVar("l4d_balance_include_witch", "0", "是否考虑增加Witch HP 0: 否 , 1:是"); 
	l4d_balance_setting_password = 	CreateConVar("l4d_balance_setting_password", "", "设置难度系数的密码"); 

	l4d_balance_health_increment = 	CreateConVar("l4d_balance_health_add", "20", "每一名额外玩家(即不包括原来的4名)导致特感增加的HP百分比 [0, 50]"); 	
	l4d_balance_health_tank = 		CreateConVar("l4d_balance_health_tank", "4000", "Tank原始HP"); 	
	l4d_balance_health_witch =		CreateConVar("l4d_balance_health_witch", "1000", "Witch原始HP");
	l4d_balance_health_hunter =		CreateConVar("l4d_balance_health_hunter", "250", "Hunter原始HP"); 
	l4d_balance_health_smoker = 	CreateConVar("l4d_balance_health_smoker", "250", "Smoker原始HP"); 
	l4d_balance_health_boomer =		CreateConVar("l4d_balance_health_boomer", "50", "Boomer原始HP"); 
	l4d_balance_health_charger = 	CreateConVar("l4d_balance_health_charger", "600", "Charger原始HP"); 
	l4d_balance_health_jockey = 	CreateConVar("l4d_balance_health_jockey", "325", "Jockey原始HP"); 
	l4d_balance_health_spitter = 	CreateConVar("l4d_balance_health_spitter", "100", "Spitter原始HP"); 
	l4d_balance_health_zombie = 	CreateConVar("l4d_balance_health_zombie", "50", "普通僵尸原始HP");

	l4d_balance_limit_special = 	CreateConVar("l4d_balance_limit_special", "4", "特感数量限制 [0, 20]");
	l4d_balance_limit_special_add = CreateConVar("l4d_balance_limit_special_add", "1", "每一名额外玩家(即不包括原来的4名)导致增加特感的数量 [0, 5]");
	l4d_balance_limit_common = 		CreateConVar("l4d_balance_limit_common", "30", "尸潮数量限制 [30, 100]"); 
	l4d_balance_limit_common_add = 	CreateConVar("l4d_balance_limit_common_add", "5", "每一名额外玩家(即不包括原来的4名)导致增加的尸潮数量 [0, 30]"); 
 	
	AutoExecConfig(true, "l4d_balance");
	
	RegConsoleCmd("sm_balance", sm_balance); 
	RegConsoleCmd("sm_difficulty", sm_difficulty); 
	RegConsoleCmd("sm_dinfo", sm_dinfo); 
	HookEvent("player_spawn", player_spawn);	
	HookEvent("player_death", player_death); 
	
	HookEvent("round_start", round_start);
	HookEvent("round_end", round_end);
	HookEvent("finale_win", map_transition);
	HookEvent("mission_lost", round_end);
	HookEvent("map_transition",  map_transition);	  	
	
	//set variables
	LeftSafeRoom = false;
	
	//resetstate
	ResetAllState();
}

public Action sm_balance(int client, int args)
{
	if(client > 0)
	{
		ShowHud[client]=!ShowHud[client];
	}
}
 
public Action sm_dinfo(int client, int args)
{
	if(client > 0)
	{
		char msgstr[500] = "";
		Format(msgstr, 500, "Survior Count : %d \n", SurvivorCount);
		Format(msgstr, 500, "\n%sTank's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_tank)), RoundFloat( GetConVarFloat(FindConVar("z_tank_health"))));
		Format(msgstr, 500, "%sWitch's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_witch)), RoundFloat( GetConVarFloat(FindConVar("z_witch_health"))));
		Format(msgstr, 500, "%sZombie's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_zombie)), RoundFloat( GetConVarFloat(FindConVar("z_health"))));
		Format(msgstr, 500, "%sSmoker's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_smoker)), RoundFloat( GetConVarFloat(FindConVar("z_gas_health"))));
		Format(msgstr, 500, "%sHunter's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_hunter)), RoundFloat( GetConVarFloat(FindConVar("z_hunter_health"))));
		Format(msgstr, 500, "%sBoomer's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_boomer)), RoundFloat( GetConVarFloat(FindConVar("z_exploding_health"))));
		if(L4D2Version)
		{
			Format(msgstr, 500, "%sCharger's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_charger)), RoundFloat( GetConVarFloat(FindConVar("z_charger_health"))));
			Format(msgstr, 500, "%sSpitter's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_spitter)), RoundFloat( GetConVarFloat(FindConVar("z_spitter_health"))));
			Format(msgstr, 500, "%sJockey's Health: %d to %d \n", msgstr, RoundFloat(GetConVarFloat(l4d_balance_health_jockey)), RoundFloat( GetConVarFloat(FindConVar("z_jockey_health"))));
		}
		Format(msgstr, 500, "\n%sSpecial infected limit : %d to %d \n", msgstr, GetConVarInt(l4d_balance_limit_special),  MaxSpecial);
		Format(msgstr, 500, "%sz_common_limit: %d to %d \n", msgstr, GetConVarInt(l4d_balance_limit_common),  RoundFloat( GetConVarFloat(FindConVar("z_common_limit"))));
		Format(msgstr, 500, "%sz_background_limit: %d \n", msgstr, RoundFloat( GetConVarFloat(FindConVar("z_background_limit"))));
		Format(msgstr, 500, "%sz_mega_mob_size: %d \n", msgstr,  RoundFloat( GetConVarFloat(FindConVar("z_mega_mob_size"))));

		PrintToChat(client, "\x04[Balance] \x05请打开控制台查看平衡系统信息");
		PrintToConsole(client, msgstr);
	}
}
 
public Action sm_difficulty(int client, int args)
{
	if(client > 0)
	{
		char password[20] = "";
		char arg[20];
		GetConVarString(l4d_balance_setting_password, password, sizeof(password));
		GetCmdArg(1, arg, sizeof(arg));
		//PrintToChatAll("arg %s, password %s", arg, password);
		if(StrEqual(arg, password))
		{
			GetCmdArg(2, arg, sizeof(arg));		 
			int d = StringToInt(arg);
			if(d >= 0 && d <= 100)
			{				
				PrintToChatAll("\x04[Balance] \x01难度系数从 \x03%d \x01调整到 \x03%d", GetConVarInt(l4d_balance_difficulty_min), d);
				SetConVarInt(FindConVar("l4d_balance_difficulty"), d);
			}
			else
			{
				PrintToChat(client, "\x04[Balance] \x03系数必须\x05>=0 \x03和 \x05<=100");				
			}
		}
		else
		{
			PrintToChat(client, "\x04[Balance] 你的密码错误");
			PrintToChatAll("\x04[Balance] \x01目前难度系数为 \x03%d", GetConVarInt(l4d_balance_difficulty_min));
		}
	}
}

public Action player_spawn(Event hEvent, const char[] strName, bool DontBroadcast)
{
	int client = GetClientOfUserId(GetEventInt(hEvent, "userid")); 
	if(client > 0)
	{
		ShowHud[client] = false;
	}
}

public Action player_death(Event hEvent, const char[] strName, bool DontBroadcast)
{
	int client = GetClientOfUserId(GetEventInt(hEvent, "userid"));
	if(client > 0)
	{
		ShowHud[client] = true;
		if(IsClientInGame(client)) PrintToChat(client, "\x04[Balance] \x03输入 \x05!balance \x03关闭平衡系统信息");
	}
}

public Action round_start(Event event, const char[] name, bool dontBroadcast)
{
	ResetAllState();
	int flags = GetConVarFlags(FindConVar("z_max_player_zombies"));
	SetConVarBounds(FindConVar("z_max_player_zombies"), ConVarBound_Upper, false);
	SetConVarFlags(FindConVar("z_max_player_zombies"), flags & ~FCVAR_NOTIFY);
	hPlayerLeftStart = CreateTimer(1.0, PlayerLeftStart, 0, TIMER_REPEAT|TIMER_FLAG_NO_MAPCHANGE);
}

public Action PlayerLeftStart(Handle Timer, any data)
{
	if (LeftStartArea())
	{
		// We don't care who left, just that at least one did
		if (!LeftSafeRoom)
		{
			LeftSafeRoom = true;
			hTimerUpdatePlayer = CreateTimer(1.0, TimerUpdatePlayer, 0, TIMER_REPEAT|TIMER_FLAG_NO_MAPCHANGE);
			hTimerShowHUD = CreateTimer(1.5, TimerShowHud, 0, TIMER_REPEAT|TIMER_FLAG_NO_MAPCHANGE);
			hTimerAjust = CreateTimer(2.0, TimerAjust, 0, TIMER_REPEAT|TIMER_FLAG_NO_MAPCHANGE);
		}
	}
	return Plugin_Continue;
}

public Action round_end(Event event, const char[] name, bool dontBroadcast)
{
	ResetAllState();
	LeftSafeRoom = false;
	KillTimer(hPlayerLeftStart);
	KillTimer(hTimerUpdatePlayer);
	KillTimer(hTimerShowHUD);
	KillTimer(hTimerAjust);
	for (int i = 1; i <= MaxClients; i++)
	{
		if (IsClientInGame(i))
		{
			if (GetClientTeam(i) == 3)
			{
				if (IsFakeClient(i))
				{
					KickClient(i);
				}
			}
		}
	}
}

public Action map_transition(Event event, const char[] name, bool dontBroadcast)
{
	int totalaverage = AllTotalIntensity / AllTotalTick; 
	PrintToServer("\x04[balance] \x01Map Change"); 
	PrintToServer("\x04[balance] \x01server intensity average %d", totalaverage); 
	for(int i = 1; i <= MaxClients; i++)
	{
		if(IsClientInGame(i) && GetClientTeam(i) == 2)
		{	
			PrintToServer("\x04[balance] \x01%N intensity average %d", i, PlayerTotalIntensity[i]/PlayerTick[i]); 
		}
	}
	ResetAllState(); 
}

public void OnMapStart()
{
	ResetAllState();
}

public void OnMapEnd()
{
	LeftSafeRoom = false;
}

void ResetAllState()
{ 
	AllTotalIntensity=0;
	AllTotalTick=1;
	DirectorStoped=false;
	AdustTick = GetConVarInt(l4d_balance_reaction_time);
	DirectorStopTick = GetConVarInt(l4d_balance_reaction_time);
	CiCount = SiCount = 0;
	NeedDrawHud = false;
	MobTick = 0;
	HaveTank = false;
	SurvivorCount = 1;
	for(int i = 1; i <= MaxClients; i++)
	{
		PlayerIntensity[i] = 0;
		PlayerTotalIntensity[i] = 0;
		PlayerTick[i] = 1;
	}
}

public Action TimerUpdatePlayer(Handle timer, any data)
{
	int playercout = 0;
	int currentAverage = 0;
	int infectedCount = 0;
	int difficult = GetConVarInt(l4d_balance_difficulty_min);
	bool needDrawHud = false;
	bool haveTank = false;
 	int survivorCount = 0;
	bool includeBot = GetConVarInt(l4d_balance_include_bot) == 1;
	for( int i = 1; i <= MaxClients; i++)
	{
		if(IsClientInGame(i))
		{
			if(GetClientTeam(i) == 2)
			{
				bool fake = IsFakeClient(i);
				if(!includeBot && fake) continue;
				if(IsPlayerAlive(i))
				{
					PlayerIntensity[i] = GetEntProp(i, Prop_Send, "m_clientIntensity" );
					PlayerTotalIntensity[i] += PlayerIntensity[i]; 
					currentAverage += PlayerIntensity[i];
				}
				else
				{
					PlayerIntensity[i] = difficult;
					PlayerTotalIntensity[i] += PlayerIntensity[i]; 
					currentAverage += PlayerIntensity[i];
				}				
				PlayerTick[i]++; 
				playercout++;
				if(ShowHud[i] && !fake) needDrawHud = true;
				survivorCount++;
			}
			else if(IsPlayerAlive(i))
			{
				infectedCount++;
				if(IsInfected(i, ZOMBIECLASS_TANK)) haveTank = true;
			}
		}
		else PlayerIntensity[i] = 0;
	}
	SurvivorCount = survivorCount;
	HaveTank = haveTank;
	NeedDrawHud = needDrawHud;
	if(playercout > 0) CurrentAverage = currentAverage / playercout; 
	else CurrentAverage = 0;
	AllTotalIntensity += CurrentAverage;
	AllTotalTick++;	
	
	SiCount = infectedCount;
	
	int reactionTime = GetConVarInt(l4d_balance_reaction_time); 
	 
	if(CurrentAverage < difficult) AdustTick--;
	else AdustTick++;
	if(AdustTick <= 0) AdustTick = 0;
	if(AdustTick >= reactionTime) AdustTick = reactionTime;
	
	if(HaveTank) AdustTick = reactionTime;
	
	if(CurrentAverage > GetConVarInt(l4d_balance_difficulty_max)) DirectorStopTick--;
	else DirectorStopTick++;
	if(DirectorStopTick <= 0) DirectorStopTick = 0;
	if(DirectorStopTick >= reactionTime) DirectorStopTick = reactionTime;
	
	if(Debug)
	{
		int totalaverage = AllTotalIntensity/AllTotalTick; 
		PrintToServer("\x04[balance] \x01current intensity %d, average %d", CurrentAverage, totalaverage); 
	}

	return Plugin_Continue;
}

public Action TimerAjust(Handle timer, any data)
{
	int siNeed = 0;
	int ciNeed = 0;
	int mobNeed = 0;
	int enable = GetConVarInt(l4d_balance_enable);
	if(enable == 0) return Plugin_Continue;

	int reactionTime = GetConVarInt(l4d_balance_reaction_time);
	UpdateSeting();
	if(DirectorStopTick == 0)
	{
		if(!DirectorStoped)
		{
			PrintToServer("Director Stopped"); 
		}
		SetConVarInt(FindConVar("director_no_specials"), 1);
		SetConVarInt(FindConVar("director_no_mobs"), 1);
		DirectorStoped=true;
	}
	else
	{
		if(DirectorStoped)
		{
			PrintToServer("Director Started"); 
		}
		SetConVarInt(FindConVar("director_no_specials"), 0);
		SetConVarInt(FindConVar("director_no_mobs"), 0);		
		DirectorStoped = false;
	}
	CiCount = GetInfectedCount();
	
	if(AdustTick == 0 ) 
	{			
		SetConVarInt(FindConVar("z_max_player_zombies"), 8);
		if(SiCount < MaxSpecial)
		{ 
			siNeed = 1;	  
		}
		MobTick += 2;
		if(CiCount < MaxCommon)
		{
			ciNeed = 0; 
			if( MobTick >= reactionTime)
			{				
				mobNeed = 1;
			}
		}
		if(siNeed > 0 || ciNeed > 0 || mobNeed > 0) Z_Spawn_Old(siNeed, ciNeed, mobNeed);
	}
	else MobTick = 0;
	return Plugin_Continue;   
}

void UpdateSeting()
{ 
	float inc = GetConVarFloat(l4d_balance_health_increment) / 100.0;	
	int survivorCount = SurvivorCount;
	if(survivorCount < 4) survivorCount = 4;	
	inc = inc * (survivorCount - 4);
	if( GetConVarInt(l4d_balance_include_zombie) == 1 )
	{
		SetConVarFloat(FindConVar("z_health"),  GetConVarFloat(l4d_balance_health_zombie) * (1.0 + inc));	
	}
	else
	{
		SetConVarFloat(FindConVar("z_health"),  GetConVarFloat(l4d_balance_health_zombie) * (1.0));	
	}
	SetConVarFloat(FindConVar("z_hunter_health"),  GetConVarFloat(l4d_balance_health_hunter) * (1.0 + inc));
	SetConVarFloat(FindConVar("z_gas_health"),  GetConVarFloat(l4d_balance_health_smoker) * (1.0 + inc));
	SetConVarFloat(FindConVar("z_exploding_health"),  GetConVarFloat(l4d_balance_health_boomer) * (1.0 + inc));
	if(L4D2Version)
	{
		SetConVarFloat(FindConVar("z_charger_health"), GetConVarFloat(l4d_balance_health_charger) * (1.0 + inc));
		SetConVarFloat(FindConVar("z_spitter_health"),  GetConVarFloat(l4d_balance_health_spitter) * (1.0 + inc));
		SetConVarFloat(FindConVar("z_jockey_health"),  GetConVarFloat(l4d_balance_health_jockey) * (1.0 + inc));
	}
	if( GetConVarInt(l4d_balance_include_witch) == 1 )
	{
		SetConVarFloat(FindConVar("z_witch_health"),  GetConVarFloat(l4d_balance_health_witch) * (1.0 + inc));
	}
	else
	{
		SetConVarFloat(FindConVar("z_witch_health"),  GetConVarFloat(l4d_balance_health_witch) * (1.0));
	}
	SetConVarFloat(FindConVar("z_tank_health"),  GetConVarFloat(l4d_balance_health_tank) * (1.0 + inc));
	MaxSpecial = GetConVarInt(l4d_balance_limit_special);
	MaxSpecial += GetConVarInt(l4d_balance_limit_special_add) * (survivorCount - 4);		
	
	MaxCommon = GetConVarInt(l4d_balance_limit_common); 
	MaxCommon += GetConVarInt(l4d_balance_limit_common_add) * (survivorCount - 4);		
	SetConVarFloat(FindConVar("z_common_limit"), MaxCommon * 1.0);
	SetConVarFloat(FindConVar("z_background_limit"), MaxCommon * 0.5);
	SetConVarFloat(FindConVar("z_mega_mob_size"), MaxCommon * 1.0);
}
 
public Action TimerDelayStartAjust(Handle timer, any data)
{
	CreateTimer(2.0, TimerAjust, 0, TIMER_REPEAT|TIMER_FLAG_NO_MAPCHANGE);
}

Handle pInfHUD 		= INVALID_HANDLE;

public Action TimerShowHud(Handle timer, any data)
{
	if(!NeedDrawHud)return Plugin_Continue;
	pInfHUD = CreatePanel(GetMenuStyleHandle(MenuStyle_Default));
	char buffer[65];	
 	SetPanelTitle(pInfHUD, "难度平衡系统"); 
	Format(buffer, sizeof(buffer), "难度系数范围 ( %d - %d )", GetConVarInt(l4d_balance_difficulty_min),GetConVarInt(l4d_balance_difficulty_max));	
	DrawPanelItem(pInfHUD, buffer, ITEMDRAW_RAWLINE);
	DrawPanelItem(pInfHUD, " ", ITEMDRAW_SPACER|ITEMDRAW_RAWLINE);
 
	Format(buffer, sizeof(buffer), "当前 : %d ",  CurrentAverage);
	DrawPanelItem(pInfHUD, buffer);
	
	int totalaverage = AllTotalIntensity / AllTotalTick;
	Format(buffer, sizeof(buffer), "平均 : %d ", totalaverage);
	DrawPanelItem(pInfHUD, buffer);
	
	if(AdustTick == 0) Format(buffer, sizeof(buffer), "正在增加难度");
	else Format(buffer, sizeof(buffer), "提升难度倒计时: %d 秒",  AdustTick);
	DrawPanelItem(pInfHUD, buffer);	
	
	if(DirectorStopTick == 0) Format(buffer, sizeof(buffer), "正在降低难度");
	else Format(buffer, sizeof(buffer), "降低难度倒计时: %d 秒",  DirectorStopTick);
	DrawPanelItem(pInfHUD, buffer);		
	
	DrawPanelItem(pInfHUD, " ", ITEMDRAW_SPACER|ITEMDRAW_RAWLINE); 
	DrawPanelItem(pInfHUD, "感染者", ITEMDRAW_RAWLINE);
	
	int sicount = SiCount;
 	 
	int cicount = CiCount;
	
	Format(buffer, sizeof(buffer), "特殊感染者 (%d) : %d ", MaxSpecial, sicount);
	DrawPanelItem(pInfHUD, buffer );
	Format(buffer, sizeof(buffer), "普通感染者 (%d): %d ", MaxCommon, cicount);
	DrawPanelItem(pInfHUD, buffer );	
	
	DrawPanelItem(pInfHUD, " ", ITEMDRAW_SPACER|ITEMDRAW_RAWLINE); 
	DrawPanelItem(pInfHUD, "生还者危险系数"); 
	DrawPanelItem(pInfHUD, " ", ITEMDRAW_SPACER|ITEMDRAW_RAWLINE);
	
	bool includeBot = GetConVarInt(l4d_balance_include_bot) == 1;
	for (int i = 1; i <= MaxClients; i++)
	{
		if (!IsClientInGame(i)) continue;
		if (GetClientTeam(i) == 3) continue;
		if (!includeBot && IsFakeClient(i)) continue;  
		{
			int a = PlayerTotalIntensity[i] / PlayerTick[i];
			Format(buffer, sizeof(buffer), "%N (%d) : %d ", i  ,a, PlayerIntensity[i]);
			DrawPanelItem(pInfHUD, buffer ,ITEMDRAW_RAWLINE);
		}
	}	
	
	for (int i = 1; i <= MaxClients; i++)
	{
		if(!IsClientInGame(i)) continue;
		if(IsFakeClient(i)) continue;  
		if(!ShowHud[i]) continue;
		if (GetClientMenu(i) == MenuSource_RawPanel || GetClientMenu(i) == MenuSource_None)
		{	
			SendPanelToClient(pInfHUD, i, Menu_InfHUDPanel, 1); 			
		}
	}
	CloseHandle(pInfHUD);  
	return Plugin_Continue;
}

public int Menu_InfHUDPanel(Menu menu, MenuAction action, int param1, int param2) { return; }

void Z_Spawn_Old(int siCount, int ciCount, int mob)
{
	int bot = CreateFakeClient("Monster");
	if (bot > 0)
	{		
		ChangeClientTeam(bot,3);
		for(int i = 0; i < siCount; i++)
		{ 
			int random = GetRandomInt(1, 6);
			if(!L4D2Version) random = GetRandomInt(1, 3);
			switch(random)
			{
				case 1:
					SpawnCommand(bot, "z_spawn_old", "smoker auto");
				case 2:
					SpawnCommand(bot, "z_spawn_old", "boomer auto");
				case 3:
					SpawnCommand(bot, "z_spawn_old", "hunter auto");
				case 4:
					SpawnCommand(bot, "z_spawn_old", "spitter auto");
				case 5:
					SpawnCommand(bot, "z_spawn_old", "jockey auto");
				case 6:
					SpawnCommand(bot, "z_spawn_old", "charger auto");
			}
		}
		for(int i = 0; i < ciCount; i++)
		{
			SpawnCommand(bot, "z_spawn_old", "auto");
		}
		if(mob > 0)
		{
			SpawnCommand(bot, "z_spawn", "mob"); 			
			MobTick = 0;
		}
		Kickbot(INVALID_HANDLE, bot);
		//CreateTimer(0.1,Kickbot,bot);
	}	  
}

public Action Kickbot(Handle timer, any client)
{
	if (IsClientInGame(client))
	{
		if (IsFakeClient(client))
		{
			KickClient(client);
		}
	}
}

stock void SpawnCommand(int client, char[] command, char[] arguments = "")
{
	if (client)
	{ 
		int flags = GetCommandFlags(command);
		SetCommandFlags(command, flags & ~FCVAR_CHEAT);
		FakeClientCommand(client, "%s %s", command, arguments);
		SetCommandFlags(command, flags);
	}
}

int GetInfectedCount()
{
	int ent = -1;
	int count = 0;
	while ((ent = FindEntityByClassname(ent,  "infected" )) != -1)
	{
		count++;
	}
	return count;
}

void GameCheck()
{
	char GameName[16];
	GetConVarString(FindConVar("mp_gamemode"), GameName, sizeof(GameName));
	
	if (StrEqual(GameName, "survival", false))
		GameMode = 3;
	else if (StrEqual(GameName, "versus", false) || StrEqual(GameName, "teamversus", false) || StrEqual(GameName, "scavenge", false) || StrEqual(GameName, "teamscavenge", false))
		GameMode = 2;
	else if (StrEqual(GameName, "coop", false) || StrEqual(GameName, "realism", false))
		GameMode = 1;
	else
	{
		GameMode = 0;
 	}
	
	GetGameFolderName(GameName, sizeof(GameName));
	if (StrEqual(GameName, "left4dead2", false))
	{
		ZOMBIECLASS_TANK = 8;
		L4D2Version = true;
	}	
	else
	{
		ZOMBIECLASS_TANK = 5;
		L4D2Version = false;
	}
}

int IsInfected(int client, int type)
{
	int class = GetEntProp(client, Prop_Send, "m_zombieClass");
	if(type == class) return true;
	else return false;
}

bool LeftStartArea()
{
	int ent = -1, maxents = GetMaxEntities();
	for (int i = MaxClients+1; i <= maxents; i++)
	{
		if (IsValidEntity(i))
		{
			char netclass[64];
			GetEntityNetClass(i, netclass, sizeof(netclass));
			
			if (StrEqual(netclass, "CTerrorPlayerResource"))
			{
				ent = i;
				break;
			}
		}
	}
	
	if (ent > -1)
	{
		int offset = FindSendPropInfo("CTerrorPlayerResource", "m_hasAnySurvivorLeftSafeArea");
		if (offset > 0)
		{
			if (GetEntData(ent, offset))
			{
				if (GetEntData(ent, offset) == 1) return true;
			}
		}
	}
	return false;
}