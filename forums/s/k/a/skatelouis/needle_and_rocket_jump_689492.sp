/* Plugin Template generated by Pawn Studio */

#include <sourcemod>
#include <sdktools>
#include <tf2>
#include <tf2_stocks>

#define PLUGIN_VERSION  "0.2"

new Handle:g_hPluginEnabled;
new Handle:g_hSpeed;
new Handle:g_hFriendlyOnly;
new String:g_tString[32];

public Plugin:myinfo = 
{
	name = "TF2 Needle Jump",
	author = "TheJCS",
	description = "Adds Needle Jumping on Team Fortress 2",
	version = PLUGIN_VERSION,
	url = ""
}

public OnPluginStart()
{
	CreateConVar("sm_needlejump_version", PLUGIN_VERSION, "Needle Jump plugin Version", FCVAR_PLUGIN|FCVAR_SPONLY|FCVAR_REPLICATED|FCVAR_NOTIFY);
	
	g_hPluginEnabled = CreateConVar("sm_needlejump", "1", "Toggles Needle Jump", FCVAR_PLUGIN, true, 0.0, true, 1.0);
	g_hSpeed = CreateConVar("sm_needlejump_speed", "200.0", "Speed to add on Needle Jump", FCVAR_PLUGIN, true, 0.0);
	g_hFriendlyOnly = CreateConVar("sm_needlejump_friendly_only", "1", "Restrict Needle Jumping to friends only", FCVAR_PLUGIN, true, 0.0, true, 1.0);
	
}

public OnGameFrame()
{
	new Float:fEyeAngle[3];
	new iTarget;
	new Float:fSpeed;
	new Float:fVelocity[3];
	if(GetConVarBool(g_hPluginEnabled)){
		for(new client = 1; client <= GetMaxClients(); client++){
			if(IsValidEntity(client) && IsClientInGame(client) && IsPlayerAlive(client)){
				if(GetClientButtons(client) & IN_ATTACK){
					GetClientWeapon(client, g_tString,32);
					if(StrEqual(g_tString, "tf_weapon_syringegun_medic") || StrEqual(g_tString, "tf_weapon_rocketlauncher")){
						if(GetEntData(GetPlayerWeaponSlot(client, 0), FindSendPropInfo("CTFWeaponBase", "m_iClip1")) != 0){
							GetClientEyeAngles(client, fEyeAngle);
							if(fEyeAngle[0] < -45.0){
								iTarget = GetClientAimTarget(client);
								if(iTarget != -1){
									if(!(GetConVarBool(g_hFriendlyOnly) && GetClientTeam(client) != GetClientTeam(iTarget))){
										if(!(GetEntityFlags(iTarget) & FL_ONGROUND)){
											fSpeed = GetConVarFloat(g_hSpeed);
											GetEntPropVector(iTarget, Prop_Data, "m_vecVelocity", fVelocity);
											//fVelocity[0] += fSpeed * Cosine(DegToRad(fEyeAngle[1]));
											//fVelocity[1] += fSpeed * Sine(DegToRad(fEyeAngle[1]));  
											fVelocity[2] += fSpeed * Sine(DegToRad(fEyeAngle[0])) * -1;
											TeleportEntity(iTarget, NULL_VECTOR, NULL_VECTOR, fVelocity);
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}
}
