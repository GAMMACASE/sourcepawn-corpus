#include <sourcemod>
#include <sdktools>
#include <tf2>
#include <tf2_stocks>

#pragma semicolon 1

#define PLAYERCOND_SPYCLOAK (1<<4)
#define PLAYERCOND_TAUNT (1<<7) //128

//http://forums.alliedmods.net/showthread.php?t=94767&highlight=cloak
//http://forums.alliedmods.net/showthread.php?t=98542&highlight=cloak

public Plugin:myinfo = 
{
	name = "Block spy taunt exploit",
	author = "Seather",
	description = "Block spy taunt+cloak exploit",
	version = "0.9",
	url = "http://www.sourcemod.net/"
}

public OnPluginStart()
{
	RegConsoleCmd("taunt", TauntAction);
}

public Action:TauntAction(client, args)
{
	//Spy only
	if(TF2_GetPlayerClass(client) != TFClass_Spy)
	{
		return Plugin_Continue;
	}

	CreateTimer(0.1, SpyCheck, client);
	CreateTimer(0.5, SpyCheck, client);
	CreateTimer(1.0, SpyCheck, client);

	return Plugin_Continue;
}

public Action:SpyCheck(Handle:timer, any:client)
{
	if(!IsClientConnected(client))
		return;
	if(!IsPlayerAlive(client))
		return;
	if(TF2_GetPlayerClass(client) != TFClass_Spy)
		return;
		
	new cond = GetEntProp(client, Prop_Send, "m_nPlayerCond");
		
	//only continue if taunting
	if (!(cond & PLAYERCOND_TAUNT))
		return;

	// decloak if cloaked
	if (cond & PLAYERCOND_SPYCLOAK)
	{
		//decloak is buggy, uber color, disguise unknown, etc
		//SetEntProp(client, Prop_Send, "m_nPlayerCond", cond | ~PLAYERCOND_SPYCLOAK);
		
		FakeClientCommand(client, "explode");
		
		//do other stuff here, like alerts
		LogAction(client, -1, "\"%L\" attempted spy taunt cloak exploit.", client);
		//PrintToChat(client,"????");
		PrintToChatAll("\"%L\" attempted spy taunt cloak exploit.", client);
		
	}
	
}


