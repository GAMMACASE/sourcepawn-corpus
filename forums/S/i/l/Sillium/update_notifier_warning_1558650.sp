/* Plugin Template generated by Pawn Studio */

#include <sourcemod>
#include <steamtools>

#define UN_VERSION "1.1.1"

new Handle:cv_enabled, Handle:cv_text, Handle:cv_restart, Handle:cv_restarttime, Handle:gTimerHandle;
new gRestartTimeLeft;

public Plugin:myinfo = 
{
   name = "UpdateNotifier",
   author = "Chefe, Sillium",
   description = "Plugin that notifiy clients about updates",
   version = UN_VERSION,
   url = "http://forums.alliedmods.net/showthread.php?p=1558570"
}

public OnPluginStart()
{
   cv_enabled = CreateConVar("sm_un_enabled", "1", "Enable/disable UpdateNotifier");
   cv_text = CreateConVar("sm_un_text", "WARNING! Update for the game has been released, server will restart for updating!", "Set text (MAX 200) that will be displayed when server needs restart for updating");
   cv_restart = CreateConVar("sm_un_restart", "0", "Set restart handling: 0 = No restart caused by the plugin, restart is done by autoupdate on mapchange; 1 = restart server if no players are online; 2 = restart server even if there are players online");
   cv_restarttime = CreateConVar("sm_un_restartdelay", "30.0", "Set the time between the Warning and the restart if is set", 0, true, 10.0);
   CreateConVar("sm_un_version", UN_VERSION, "Shows current plugin version.", FCVAR_PLUGIN|FCVAR_SPONLY|FCVAR_REPLICATED|FCVAR_NOTIFY|FCVAR_DONTRECORD);
   gRestartTimeLeft = GetConVarInt(cv_restarttime);
   
   AutoExecConfig(true);
}

public Action:Steam_RestartRequested()
{
   if (GetConVarBool(cv_enabled))
   {
      new String:text[200];
      GetConVarString(cv_text, text, sizeof(text));
      PrintToChatAll("\x04%s", text);
      PrintHintTextToAll("%s", text);
      
      if (GetConVarInt(cv_restart))
      {
         gTimerHandle = CreateTimer(10.0, Timer_Restart, INVALID_HANDLE, TIMER_REPEAT);
         gRestartTimeLeft -= 10;
      }
   }
   
   return Plugin_Continue;
}

public Action:Timer_Restart(Handle:timer)
{
   if(gRestartTimeLeft > 0)
   {
      if (GetConVarInt(cv_restart) == 2)
      {
         PrintToChatAll("\x04 Update received. Rebooting in %d seconds!", gRestartTimeLeft);
         PrintHintTextToAll("Update received. Rebooting in %d seconds!", gRestartTimeLeft);
      }
      gRestartTimeLeft -= 10;
   }
   else
   {
      if (GetConVarInt(cv_restart) == 1)
      {
         if (GetClientCount(false) == 0)
         {
            ServerCommand("quit");
         }
      }
      else if (GetConVarInt(cv_restart) == 2)
      {
         PrintToChatAll("\x04 Update received. Rebooting!");
         PrintHintTextToAll("Update received. Rebooting!");
         CloseHandle(gTimerHandle);
         ServerCommand("quit");
      }
   }
}
