/* Plugin Template generated by Pawn Studio */

#pragma semicolon 1

#include <sourcemod>
#include <cstrike>
#include <sdktools>

#define VERSION "1.0.0"

public Plugin:myinfo = 
{
	name = "Grenade Spam Prevention",
	author = "FlyingMongoose",
	description = "Prevents people from buying more than their first set of grenades",
	version = VERSION,
	url = "http://www.interwavestudios.com/"
}

new bool:FirstHEBuy[MAXPLAYERS+1];
new bool:FirstSGBuy[MAXPLAYERS+1];
new FBBuyCount[MAXPLAYERS+1];

new Handle:cvarEnableNadeSpamPrevent;

public OnPluginStart()
{
	CreateConVar("nadespam_version",VERSION, _,FCVAR_PLUGIN|FCVAR_NOTIFY|FCVAR_REPLICATED|FCVAR_SPONLY);
	cvarEnableNadeSpamPrevent = CreateConVar("sm_preventnadespam","1","Enables/Disables nade spam prevention",FCVAR_PLUGIN,true,0.0,true,1.0);
	RegConsoleCmd("buy", Command_Buy);
	HookEvent("player_spawn",OnPlayerSpawn);
}

public Action:Command_Buy(client, args)
{
	if(GetConVarInt(cvarEnableNadeSpamPrevent) == 1)
	{
		decl String:f_Weapon[64];
		GetCmdArg(1, f_Weapon, sizeof(f_Weapon));
		if(strcmp(f_Weapon,"hegrenade") == 0)
		{
			if(!FirstHEBuy[client])
			{
				PrintToChat(client, "You are only allowed 1 HE grenade per round");
				return Plugin_Handled;
			}
			else
			{
				FirstHEBuy[client] = false;
				return Plugin_Continue;
			}
		}
		if(strcmp(f_Weapon,"smokegrenade") == 0)
		{
			if(!FirstSGBuy[client])
			{
				PrintToChat(client, "You are only allowed 1 smoke grenade per round");
				return Plugin_Handled;
			}
			else
			{
				FirstSGBuy[client] = false;
				return Plugin_Continue;
			}
		}
		if(strcmp(f_Weapon,"flashbang") == 0)
		{
			if(FBBuyCount[client] >= 2)
			{
				PrintToChat(client, "You are only allowed 2 flash bangs per round");
				return Plugin_Handled;
			}
			else
			{
				++FBBuyCount[client];
				return Plugin_Continue;
			}
		}
		return Plugin_Continue;
	}
	return Plugin_Continue;
}

public OnPlayerSpawn(Handle:event, const String:name[], bool:dontBroadcast)
{
	if(GetConVarInt(cvarEnableNadeSpamPrevent) == 1)
	{
		new client = GetClientOfUserId(GetEventInt(event,"userid"));
		FirstHEBuy[client] = true;
		FirstSGBuy[client] = true;
		FBBuyCount[client] = 0;
	}
}