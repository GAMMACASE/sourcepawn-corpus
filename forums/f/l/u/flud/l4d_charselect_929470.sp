/* Plugin Template generated by Pawn Studio */

/*
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/* Version History
* 0.x	- Base code (setting up the correct convars and retrieving models).
* 1.0	- First release.
*/

// define
#define PLUGIN_VERSION "1.0"
#define PLUGIN_NAME "L4D Character selector"

// includes
#include <sourcemod>
#include <sdktools>

// Client numbers are dynamic, keep changing according to the spawn order
new bool:g_bSpawned[MAXPLAYERS+1];

// CVars Handles
new Handle:g_hActivate=INVALID_HANDLE;

public Plugin:myinfo = 
{
	name = PLUGIN_NAME,
	author = "MagnoT",
	description = "[L4D] Lets players select a character to play with",
	version = PLUGIN_VERSION,
	url = "http://www.sourcemod.net/" //http://driftinc.co.nr
}

public OnPluginStart()
{
	HookEvent("player_team", ChangeTeam, EventHookMode_Post);
	// Clean up the spawn variable (deprecated)
	for(new i=1; i<=GetMaxClients(); ++i)
	{
		g_bSpawned[i]=false;
	}
	
	RegConsoleCmd("sm_csp", Csp_Cmd);
	
	// convars
	g_hActivate = CreateConVar("l4d_chars_enable", "1", "[L4D] Turn on/off character select panel", FCVAR_PLUGIN|FCVAR_NOTIFY);
	
	// config file
	AutoExecConfig(true, "L4D_charselect");
}

public Action:Csp_Cmd(client, args)
{

		g_bSpawned[client]=false;
		CreateTimer(0.2, PlayerPanel, client);

}

public ChangeTeam(Handle:event, const String:name[], bool:dontBroadcast)
if(GetConVarInt(g_hActivate)==1)
	{
	new client = GetClientOfUserId(GetEventInt(event, "userid"));
	new ClTeam = GetEventInt(event, "team");
	if ((g_bSpawned[client]==false)&&(client>0)&&(IsClientInGame(client))&&(!IsFakeClient(client))&&(ClTeam==2))	
		{
			CreateTimer(10.0, PlayerPanel, client);
		}
	}

public OnClientPutInServer(client)
{
	if (client>0)
	{
		g_bSpawned[client]=false;
	}
}

public CharPanel(Handle:menu, MenuAction:action, param1, param2)
{
	if (action == MenuAction_Select)
	{
		switch (param2)
		{
			case 1:
			{
				// get prop
				new offset = FindSendPropInfo("CTerrorPlayer", "m_survivorCharacter");
				new char = GetEntData(param1, offset, 1);
				
				// set char
				char = 1;
				SetEntData(param1, offset, char, 1, true);
				
				// update client model info
				decl String:model[] = "models/survivors/survivor_teenangst.mdl";
				SetEntityModel(param1, model);
				
				PrintToChat(param1, "\x05[ \x01You're now playing as the Sexy lady - Zoey");
			}
			case 2:
			{
				// get prop
				new offset = FindSendPropInfo("CTerrorPlayer", "m_survivorCharacter");
				new char = GetEntData(param1, offset, 1);

				// set char
				char = 2;
				SetEntData(param1, offset, char, 1, true);
				
				// update client model info
				decl String:model[] = "models/survivors/survivor_biker.mdl";
				SetEntityModel(param1, model);
				
				PrintToChat(param1, "\x05[ \x01You're now playing as the crackhead - Francis");
			}
			case 3:
			{
				// get prop
				new offset = FindSendPropInfo("CTerrorPlayer", "m_survivorCharacter");
				new char = GetEntData(param1, offset, 1);

				// set char
				char = 3;
				SetEntData(param1, offset, char, 1, true);
				
				// update client model info
				decl String:model[] = "models/survivors/survivor_manager.mdl";
				SetEntityModel(param1, model);
				
				PrintToChat(param1, "\x05[ \x01You're now playing as Tech Support - Louis");
			}
			case 4:
			{
				// get prop
				new offset = FindSendPropInfo("CTerrorPlayer", "m_survivorCharacter");
				new char = GetEntData(param1, offset, 1);

				// set char
				char = 0;
				SetEntData(param1, offset, char, 1, true);
				
				// update client model info
				decl String:model[] = "models/survivors/survivor_namvet.mdl";
				SetEntityModel(param1, model);
				
				PrintToChat(param1, "\x05[ \x01You're now playing as Ultimate Grandpa - Bill");
			}
		}
		
	} else if (action == MenuAction_Cancel)
	{
	
	}
}
 
public Action:PlayerPanel(Handle:timer, any:client) //client, args)
{
	
	if(!IsClientInGame(client)) return;
	if(GetClientTeam(client)!=2) return;
	
	new Handle:panel = CreatePanel();
	SetPanelTitle(panel, "Choose a character:");

	DrawPanelText(panel, "     ");
	DrawPanelItem(panel, "Zoey");		//1
	DrawPanelItem(panel, "Francis"); 	//2
	DrawPanelItem(panel, "Louis"); 		//3
	DrawPanelItem(panel, "Bill"); 		//4
 
	if (g_bSpawned[client]==false)
	{
		SendPanelToClient(panel, client, CharPanel, 20);
		g_bSpawned[client]=true;
	}
 
	CloseHandle(panel);
}