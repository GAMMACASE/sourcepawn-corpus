/* Plugin Template generated by Pawn Studio */
#pragma newdecls required
#include <sourcemod>

#define PLUGIN_VERSION "1.4"
#define FL_CUMSKEET 1
#define FL_DEADSTOPS 2
#define FL_ALLSKEET 4
#define HITGROUP_HEAD 1
int pouncing[MAXPLAYERS + 1];
//Skeet damage variables
int damageDone[MAXPLAYERS+1][MAXPLAYERS+1];
int hitsDone[MAXPLAYERS+1][MAXPLAYERS+1];
int headshots[MAXPLAYERS+1][MAXPLAYERS+1];

char hitboxNames[8][20] = { "Body", "Head", "Chest", "Stomach", "Left Arm", "Right Arm", "Left Leg", "Right Leg"};

Handle hVerbosity;
Handle hDeathSkeets;

bool bIsL4D2;

char l4d_WeaponNames[][] =
{
    "autoshotgun",
    "smg",
    "rifle",
    "pumpshotgun",
	"hunting_rifle",
	"pistol",
	"pipe_bomb",
	"prop_minigun"
}

char l4d2_WeaponNames[][] =
{
    "pistol",
    "pistol_magnum",
    "shotgun_chrome",
    "pumpshotgun",
	"autoshotgun",
	"shotgun_spas",
	"smg",
	"smg_silenced",
	"rifle",
	"rifle_ak47",
	"rifle_desert",
	"rifle_sg552",
	"rifle_m60",
	"hunting_rifle",
	"sniper_military",
	"weapon_grenade_launcher",
	"frying_pan",
	"electric_guitar",
	"machete",
	"tonfa",
	"fireaxe",
	"crowbar",
	"baseball_bat",
	"cricket_bat",
	"golfclub",
	"katana",
	"knife",
	"chainsaw",
	"spawnminigun",
	"spawnminigun2"
}

public Plugin myinfo = 
{
	name = "Skeet Announce",
	author = "n0limit, $atanic $pirit",
	description = "Announces damage done to a hunter during a pounce in midair (skeets) and dead stops",
	version = PLUGIN_VERSION,
	url = "http://forums.alliedmods.net/showthread.php?p=923976"
}

public void OnPluginStart()
{
	// Checking if its L4D or L4D2
	char GameName[16];
	GetGameFolderName(GameName, sizeof(GameName));
	if (StrEqual(GameName, "left4dead2", false))
		bIsL4D2 = true;
	else
		bIsL4D2 = false;
	
	HookEvent("player_shoved",Event_PlayerShoved);
	HookEvent("player_hurt",Event_PlayerHurt);
	HookEvent("ability_use",Event_AbilityUse);
	HookEvent("player_death",Event_PlayerDeath);
	
	CreateConVar("skeetannounce_version", PLUGIN_VERSION, "SkeetAnnounce Version", FCVAR_SPONLY|FCVAR_REPLICATED|FCVAR_NOTIFY|FCVAR_DONTRECORD);
	hVerbosity = CreateConVar("skeetannounce_verbosity", "3", "The verbosity level of skeet announce. Default is 3.", FCVAR_SPONLY|FCVAR_NOTIFY);
	hDeathSkeets = CreateConVar("skeetannounce_deathskeets", "1", "Only prints skeet information if the player is killed by the skeet. Otherwise, it prints any damage incured while skeeting. Default is 1.", FCVAR_SPONLY|FCVAR_NOTIFY);
	AutoExecConfig(true,"skeetannounce");
}

public void Event_PlayerShoved(Event event, const char[] name, bool dontBroadcast)
{
	int victim = GetClientOfUserId(GetEventInt(event, "userid"));
	int attacker = GetClientOfUserId(GetEventInt(event, "attacker"));
	char attackerName[MAX_NAME_LENGTH];
	char victimName[MAX_NAME_LENGTH];
	
	//If the hunter lands on another player's head, they're technically grounded.
	//Instead of using isGrounded, this uses the pouncing[] array with less precise timer
	if(pouncing[victim] && GetConVarInt(hVerbosity) & FL_DEADSTOPS)
	{ //Dead Stop
		GetClientName(victim,victimName,sizeof(victimName));
		GetClientName(attacker,attackerName,sizeof(attackerName));
		PrintToChatAll("[\x03Skeet\x01]%s deadstopped %s", attackerName, victimName);
	}
}

public void Event_PlayerHurt(Event event, const char[] name, bool dontBroadcast)
{
	int user = GetClientOfUserId(GetEventInt(event, "userid"));
	if(pouncing[user])
	{ 
		int attacker = GetClientOfUserId(GetEventInt(event, "attacker"));
		int victim = GetClientOfUserId(GetEventInt(event,"userid"));
		int damage = GetEventInt(event,"dmg_health");
		int hitGroup = GetEventInt(event,"hitgroup");
		char attackerName[MAX_NAME_LENGTH];
		char victimName[MAX_NAME_LENGTH];
		char weapon[MAX_NAME_LENGTH];

		GetEventString(event, "weapon", weapon, sizeof(weapon));
		GetClientName(victim, victimName, sizeof(victimName));
		GetClientName(attacker, attackerName, sizeof(attackerName));
		if(isAcceptableWeapon(weapon))
		{
			if(GetConVarInt(hVerbosity) & FL_CUMSKEET)
			{
				damageDone[victim][attacker] += damage;
				hitsDone[victim][attacker]++;
				if(hitGroup == HITGROUP_HEAD)
					headshots[victim][attacker]++;
			}
			if(GetConVarInt(hVerbosity) & FL_ALLSKEET)
				PrintToChatAll("[\x03Skeet\x01]%s skeeted %s in the %s with %s for %d HP", attackerName, victimName, hitboxNames[hitGroup], weapon, damage);
		}
	}
}

public void Event_PlayerDeath(Event event, const char[] name, bool dontBroadcast)
{
	int victim = GetClientOfUserId(GetEventInt(event,"userid"));
	char victimName[MAX_NAME_LENGTH];
	char playerName[MAX_NAME_LENGTH];
	
	GetClientName(victim,victimName,sizeof(victimName));
	if(!GetConVarBool(hDeathSkeets) || pouncing[victim])
	{
		if(GetConVarInt(hVerbosity) & FL_CUMSKEET)
		{
			for(int i = 0; i < MaxClients; i++)
			{
				if(hitsDone[victim][i] > 0)
				{
					GetClientName(i,playerName,sizeof(playerName));
					if(headshots[victim][i] > 0)
						PrintToChatAll("[\x03Skeet\x01]%s skeeted %s, landing %d bullet(s) with %d headshot(s) for %d damage", playerName,victimName,hitsDone[victim][i],headshots[victim][i],damageDone[victim][i]);
					else
						PrintToChatAll("[\x03Skeet\x01]%s skeeted %s, landing %d bullet(s) for %d damage", playerName,victimName,hitsDone[victim][i],damageDone[victim][i]);
					hitsDone[victim][i] = 0;
					damageDone[victim][i] = 0;
					headshots[victim][i] = 0;
				}
			}
		}
	}
}

public void Event_AbilityUse(Event event, const char[] name, bool dontBroadcast)
{
	int user = GetClientOfUserId(GetEventInt(event, "userid"));
	char abilityName[64];
	
	GetEventString(event,"ability",abilityName,sizeof(abilityName));
	if(isClient(user) && strcmp(abilityName,"ability_lunge",false) == 0 && !pouncing[user])
	{
		//Hunter pounce
		pouncing[user] = true;
		CreateTimer(0.5,groundTouchTimer,user,TIMER_REPEAT);
	}
}

public Action groundTouchTimer(Handle timer, any client)
{
	if((isClient(client) && isGrounded(client)) || !IsPlayerAlive(client))
	{
		//Reached the ground or died in mid-air
		pouncing[client] = false;
		KillTimer(timer);
	}
}

public bool isGrounded(int client)
{
	return (GetEntProp(client,Prop_Data,"m_fFlags") & FL_ONGROUND) > 0;
}

public bool isClient(int client)
{
	return IsClientConnected(client) && IsClientInGame(client) && !IsFakeClient(client);
}

public bool isAcceptableWeapon(const char[] weapon)
{
	bool bIsWeaponFound;

	if(bIsL4D2)
	{
		for (int i = 0; i < sizeof(l4d2_WeaponNames); i++) 
		{
			if (StrEqual(l4d2_WeaponNames[i], weapon)) 
			{
				bIsWeaponFound = true;
				break;
			}
		}
	}
	if(!bIsL4D2)
	{	
		for (int i = 0; i < sizeof(l4d_WeaponNames); i++) 
		{
			if (StrEqual(l4d_WeaponNames[i], weapon)) 
			{
				bIsWeaponFound = true;
				break;
			}
		}
	}
	
	if (bIsWeaponFound)
	{
		return true;
	}
	PrintToChatAll("[\x03Skeet\x01]Could not find weapon name")
	return false;	
}