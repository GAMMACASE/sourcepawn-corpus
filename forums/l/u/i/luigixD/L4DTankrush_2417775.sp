/* Plugin Template generated by Pawn Studio */

#include <sourcemod>
#pragma semicolon 1
#define PLUGIN_VERSION "1.04"
#define CVAR_FLAGS FCVAR_PLUGIN

public Plugin:myinfo = 
{
	name = "[L4D2] Tank Rush",
	author = "Grammernatzi",
	description = "Spawns an endless amount of tanks.",
	version = PLUGIN_VERSION,
	url = ""
}

new Handle:tankrushon;
new timertick;
new Handle:tankinterval;
new Handle:tankdeathheal;
new Handle:tankhealthcvar;

public OnPluginStart()
{
	CreateConVar("tankrush_version", PLUGIN_VERSION, "Tankrush_Version", FCVAR_PLUGIN|FCVAR_SPONLY|FCVAR_REPLICATED|FCVAR_NOTIFY);
	tankrushon = CreateConVar("tankrush_on","1", "Is tank rush on? Default = 1", CVAR_FLAGS, true, 0.0);
	tankinterval = CreateConVar("tankrush_interval","12", "How many seconds till another tank spawns.", CVAR_FLAGS, true, 0.0);
	tankdeathheal = CreateConVar("tankrush_heal","1", "Will survivors be healed on tank death? Default = 1", CVAR_FLAGS, true, 0.0);
	tankhealthcvar = CreateConVar("tankrush_health","4000", "What is tank health set to? Default is 4000.", CVAR_FLAGS, true, 0.0);
	
	CreateTimer(1.0,TimerUpdate, _, TIMER_REPEAT);
	HookEvent("tank_killed", TankKill);
	
	AutoExecConfig(true,"L4DTankrush");
	
	return Plugin_Handled;
}

new defaultclimit;
new defaulthealth;
new wason;
new first;

public Action:TimerUpdate(Handle:timer)
{
	
	new Handle:directornobosses;
	new Handle:directornomobs;
	new Handle:directornospecials;
	new Handle:commonlimit;
	new Handle:tankhealth;
	directornobosses = FindConVar("director_no_bosses");
	directornomobs = FindConVar("director_no_mobs");
	directornospecials = FindConVar("director_no_specials");
	commonlimit = FindConVar("z_common_limit");
	tankhealth = FindConVar("z_tank_health");
	if (!first)
	{
		defaulthealth = GetConVarInt(tankhealth);
		defaultclimit = GetConVarInt(commonlimit);
		first = 1;
	}
	if (GetConVarBool(tankrushon))
	{
		wason = 1;
		SetConVarInt(directornobosses, 1);
		SetConVarInt(directornomobs, 1);
		SetConVarInt(directornospecials, 1);
		SetConVarInt(commonlimit, 0);
		SetConVarInt(tankhealth, GetConVarInt(tankhealthcvar));
	}
	else
	{
		if(wason)
		{
			new flags3 = GetCommandFlags("director_start");
			SetCommandFlags("director_start", flags3 & ~FCVAR_CHEAT);
			FakeClientCommand(1, "director_start");
				
			SetCommandFlags("director_start", flags3|FCVAR_CHEAT);
			SetConVarInt(directornobosses, 0);
			SetConVarInt(directornomobs, 0);
			SetConVarInt(directornospecials, 0);
			SetConVarInt(commonlimit, defaultclimit);
			SetConVarInt(tankhealth, defaulthealth);
			wason = 0;
		}
	}
	
	if (GetConVarBool(tankrushon))
	{
		new flags2 = GetCommandFlags("director_stop");
		SetCommandFlags("director_stop", flags2 & ~FCVAR_CHEAT);
		FakeClientCommand(1, "director_stop");
			
		SetCommandFlags("director_stop", flags2|FCVAR_CHEAT);
		
		timertick += 1;
		if (timertick >= GetConVarInt(tankinterval))
		{
			new flags = GetCommandFlags("z_spawn");
			SetCommandFlags("z_spawn", flags & ~FCVAR_CHEAT);
			
			
			for(new i = 1;i <= MAXPLAYERS;i++)
			{
				if (IsClientConnected(i))
				{
					FakeClientCommand(1, "z_spawn tank auto");
					break;
				}
			}
		
			SetCommandFlags("z_spawn", flags|FCVAR_CHEAT);
			
			timertick = 0;
		}
	}
	
}

public Action:TankKill(Handle:event, String:event_name[], bool:dontBroadcast)
{
	if (GetConVarBool(tankdeathheal))
	{
		new flags = GetCommandFlags("give");
		SetCommandFlags("give", flags & ~FCVAR_CHEAT);
				
		for (new i = 1; i <= MaxClients; i++)
		{
			if (IsClientConnected(i))
			{
				if (GetClientTeam(i) != 3)
				{
					FakeClientCommand(i, "give health");
				}
			}
		}

		SetCommandFlags("give", flags|FCVAR_CHEAT);
	}
}
