#include <sourcemod>
#include <sdkhooks>


public Plugin:myinfo = {
	name = "[TF2] Ghost-Heavy patch.",
	author = "J_Tanzanite",
	description = "Patches the ghost-heavy exploit.",
	version = "1.0.0",
	url = ""
};


public void OnPluginStart()
{
	HookEvent("player_spawn", event_spawn, EventHookMode_Post);
}

public Action event_spawn(Event event, const char []name, bool dontBroadcast)
{
	int userid = GetEventInt(event, "userid", 0);
	int client = GetClientOfUserId(userid);

	// Wait 5 seconds before checking, just in case.
	if (is_player_valid(client))
		CreateTimer(5.0, timer_check_client, userid);
}

public Action timer_check_client(Handle timer, int userid)
{
	int client = GetClientOfUserId(userid);

	if (!is_player_valid(client))
		return;

	// Possible exploit detected, check again in two seconds.
	if ((GetEntityFlags(client) & FL_TRANSRAGDOLL))
		CreateTimer(2.0, timer_re_check, userid);
}

public Action timer_re_check(Handle timer, int userid)
{
	int client = GetClientOfUserId(userid);

	if (!is_player_valid(client))
		return;

	// Client detected using the exploit, kill.
	if ((GetEntityFlags(client) & FL_TRANSRAGDOLL)) {
		PrintCenterText(client, "Ghost-Heavy exploit detected, bye bye.");
		SDKHooks_TakeDamage(client, 0, 0, 1000.0);
		CreateTimer(2.0, timer_re_check, userid);
	}
}

bool is_player_valid(int client)
{
	return (client >= 1 && client <= MaxClients
		&& IsClientConnected(client) && IsClientInGame(client));
}
