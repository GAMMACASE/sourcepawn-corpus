/* Plugin Template generated by Pawn Studio */

#include <sourcemod>
#include <cstrike>
#include <sdktools>
#include <sdkhooks>
#include <events>
#include <string>

enum Slots
{
	SlotPrimary,
	SlotSecondary,
	SlotKnife,
	SlotGrenade,
	SlotC4,
	SlotNone
}

new FavPri[MAXPLAYERS]
new FavSec[MAXPLAYERS]

new String:WpnCodeNamePri[23][]=
{
	"weapon_nova","weapon_xm1014","weapon_sawedoff","weapon_mag7","weapon_m249","weapon_negev",
	"weapon_mac10","weapon_mp9","weapon_mp7","weapon_p90","weapon_ump45","weapon_bizon",
	"weapon_ak47","weapon_m4a1","weapon_galilar","weapon_famas","weapon_sg556","weapon_aug",
	"weapon_m4a1_silencer","weapon_ssg08","weapon_awp","weapon_g3sg1","weapon_scar20"
}

new String:WpnCodeNameSec[10][]=
{
	"weapon_glock","weapon_hkp2000","weapon_deagle","weapon_p250","weapon_elite","weapon_cz75a",
	"weapon_tec9","weapon_fiveseven","weapon_usp_silencer","weapon_revolver"
}

new WpnTeamPri[23]=
{
	0,0,2,3,0,0,
	2,3,0,0,0,0,
	2,3,2,3,2,3,
	3,0,0,2,3
}

new WpnTeamSec[10]=
{
	2,3,0,0,0,0,
	2,3,3,0
}

new String:WpnCnNamePri[23][]=
{
	"Nova","XM1014","Sawed-Off","MAG-7","M249","Negev",
	"MAC-10","MP9","MP7","P90","UMP-45","PP-Bizon",
	"AK-47","M4A4","Galil AR","FAMAS","SG 553","AUG",
	"M4A1 Silencer","SSG 08","AWP","G3SG1","SCAR-20"
}

new String:WpnCnNameSec[10][]=
{
	"Glock-18","P2000","Desert Eagle","P250","Dual Berettas","CZ75 Auto",
	"Tec-9","Five-SeveN","USP Silencer","R8 Revolver"
}

new bool:Fighting=false

new StealthTimeRemain[MAXPLAYERS]
new bool:FlashlightUsing[MAXPLAYERS]

new GameTipsLoop[MAXPLAYERS]
new Handle:GameTipsHandle[MAXPLAYERS]

new bool:TacticalTips[MAXPLAYERS]

#define HEGrenadeOffset 14
#define FlashbangOffset 15
#define SmokegrenadeOffset 16
#define IncenderyGrenadesOffset 17
#define DecoyGrenadeOffset 18

public Plugin:myinfo = 
{
	name = "Ghost_english",
	author = "apocalyptic",
	description = "Ghost mode for CS:GO (English)",
	version = "beta",
	url = "http://hcgaming.net/"
}

public OnPluginStart()
{
	RegConsoleCmd("hc_gun_menu_pri",ShowGunMenuPri)
	RegConsoleCmd("hc_gun_menu_sec",ShowGunMenuSec)
	
	HookEvent("player_spawn", PlayerSpawn)
	HookEvent("player_death",PlayerDeath,EventHookMode_Pre)
	HookEvent("round_end", RoundEnd)
	
	AddCommandListener(Command_Say, "say")
	AddCommandListener(Command_Say, "say_team")
	AddCommandListener(Command_PressG, "drop")
	AddCommandListener(Command_Cmd2, "buyammo2")
}

public OnMapStart()
{
	SetConVarString(FindConVar("mp_teamname_1"), "Human")
	SetConVarString(FindConVar("mp_teamname_2"), "Ghost")
	ServerCommand("exec server.cfg")
}

public OnClientAuthorized(client)
{
	InitializeClientData(client)
}

public OnClientPutInServer(client)
{
	SDKHook(client, SDKHook_OnTakeDamage, OnTakeDamage)
}

public PlayerSpawn(Handle:event, const String:name[], bool:dontBroadcast)
{
	new client=GetClientOfUserId(GetEventInt(event, "userid"))
	new Team=GetClientTeam(client)
	if (Team==CS_TEAM_CT || Team==CS_TEAM_T)
	{
		StealthTimeRemain[client]=0
		GameTipsLoop[client]=3
		if (GameTipsHandle[client]!=INVALID_HANDLE)
		{
			KillTimer(GameTipsHandle[client])
			GameTipsHandle[client]=INVALID_HANDLE
		}
		GameTipsHandle[client]=CreateTimer(10.0,ShowGameTips,client,TIMER_REPEAT)
		if (Team==CS_TEAM_T)
		{
			SetEntityRenderFx(client,RENDERFX_DISTORT)
			new WpnEnt=GetPlayerWeaponSlot(client,_:SlotKnife)
			if (WpnEnt!=-1)
			{
				new WpnWorldModel=GetEntPropEnt(WpnEnt, Prop_Send, "m_hWeaponWorldModel")
				if (WpnWorldModel!=-1)
					SetEntProp(WpnWorldModel, Prop_Send, "m_nModelIndex", 0)
			}
		}
		else
		{			
			CreateTimer(0.1,RemoveRadar,client)
			GivePlayerItem(client, "weapon_taser")
			FakeClientCommand(client, "use weapon_taser")
			int iWeapon
			iWeapon = GetEntPropEnt(client, Prop_Send, "m_hActiveWeapon")
			if (IsValidEdict(iWeapon))
			{
				if (FindSendPropInfo("CBasePlayer", "m_iAmmo"))
					SetEntData(iWeapon, FindSendPropInfo("CWeaponTaser", "m_iClip1"), 5, _, true)
			}
			new WeaponIndex
			RemoveGuns(client,1)
			if (FavPri[client]==-1)
				WeaponIndex=GetRandomInt(0,22)
			else
				WeaponIndex=FavPri[client]
			if (WpnTeamPri[WeaponIndex]!=0)
				SetEntProp(client, Prop_Data, "m_iTeamNum", WpnTeamPri[WeaponIndex])
			GivePlayerItem(client,WpnCodeNamePri[WeaponIndex])
			RemoveGuns(client,2)
			if (FavSec[client]==-1)
				WeaponIndex=GetRandomInt(0,9)
			else
				WeaponIndex=FavSec[client]
			if (WpnTeamSec[WeaponIndex]!=0)
				SetEntProp(client, Prop_Data, "m_iTeamNum", WpnTeamSec[WeaponIndex])
			GivePlayerItem(client,WpnCodeNameSec[WeaponIndex])
			SetEntProp(client, Prop_Data, "m_iTeamNum", CS_TEAM_CT)		
			RemoveGuns(client,4)
			GivePlayerItem(client,"weapon_hegrenade")
			SetEntProp(client, Prop_Data, "m_iAmmo", 5, _, HEGrenadeOffset)
			GivePlayerItem(client,"weapon_incgrenade")
			SetEntProp(client, Prop_Data, "m_iAmmo", 5, _, IncenderyGrenadesOffset)
			GivePlayerItem(client,"weapon_decoy")
			SetEntProp(client, Prop_Data, "m_iAmmo", 5, _, DecoyGrenadeOffset)
		}
	}
}

public Action:CS_OnBuyCommand(client, const String:weapon[])
{
	PrintHintText(client,"You can NOT buy anything.\nPress <font color='#ff0000'>G</font> to select your guns.")
	return Plugin_Stop
}

public Action:OnPlayerRunCmd(client, &button)
{
	if (!(0<client<MAXPLAYERS))
		return Plugin_Stop
	if (IsPlayerAlive(client))
	{
		if (GetClientTeam(client)==CS_TEAM_CT)
		{
			if (Fighting)
			{
				if ((button & IN_SPEED) == IN_SPEED)
				{
					if (!FlashlightUsing[client])
					{
						FlashlightUsing[client]=true
						SetEntProp(client, Prop_Send, "m_fEffects", GetEntProp(client, Prop_Send, "m_fEffects") ^ 4)
					}
				}
				else
				{
					if (FlashlightUsing[client])
					{
						FlashlightUsing[client]=false
						SetEntProp(client, Prop_Send, "m_fEffects", GetEntProp(client, Prop_Send, "m_fEffects") ^ 4)
					}
				}
			}
			else
			{
				if (FlashlightUsing[client])
				{
					FlashlightUsing[client]=false
					SetEntProp(client, Prop_Send, "m_fEffects", GetEntProp(client, Prop_Send, "m_fEffects") ^ 4)
				}
			}
		}
	}
	return Plugin_Continue
}

public Action:PlayerDeath(Handle:event, const String:name[], bool:dontBroadcast)
{
	new Killer=GetClientOfUserId(GetEventInt(event, "attacker"))
	if (!IsValidEntity(Killer))
		return
	new Victim=GetClientOfUserId(GetEventInt(event, "userid"))
	if (!IsValidEntity(Victim))
		return
	StealthTimeRemain[Victim]=0
	FlashlightUsing[Victim]=false
	GameTipsLoop[Victim]=0
	if (GameTipsHandle[Victim]!=INVALID_HANDLE)
	{
		KillTimer(GameTipsHandle[Victim])
		GameTipsHandle[Victim]=INVALID_HANDLE
	}
	return
}

public RoundEnd(Handle:event, const String:name[], bool:dontBroadcast)
{
	Fighting=false
}

public Action:OnClientCommand(client)
{
	new String:command[32]
	GetCmdArgString(command, sizeof(command))
	StripQuotes(command)
	if (StrEqual(command, "autobuy") || StrEqual(command, "rebuy"))
	{
		PrintHintText(client,"You can NOT buy anything.\nPress <font color='#ff0000'>G</font> to select your guns.")
		return Plugin_Stop
	}
	return Plugin_Continue
}

public OnClientDisconnect(client)
{
	InitializeClientData(client)
	SDKUnhook(client, SDKHook_OnTakeDamage, OnTakeDamage)
}

public Action:Command_Say(client, const String:command[], args)
{
	decl String:Text[256]
	if (!client || IsChatTrigger() || GetCmdArg(1,Text,sizeof(Text))<1)
		return Plugin_Continue
	if (StrEqual(Text,"gun") || StrEqual(Text,"!gun") || StrEqual(Text,"/gun") || StrEqual(Text,"guns") || StrEqual(Text,"/guns"))
	{
		ClientCommand(client,"hc_gun_menu_pri")
		return Plugin_Stop
	}
	return Plugin_Continue
}

public Action:Command_PressG(client, const String:command[], argc)
{
	if (IsClientConnected(client) && IsClientInGame(client))
		ClientCommand(client,"hc_gun_menu_pri")
}

public Action:Command_Cmd2(client, const String:command[], args)
{
	if (IsClientConnected(client) && IsClientInGame(client))
	{
		if (TacticalTips[client])
		{
			TacticalTips[client]=false
			PrintHintText(client,"Tips is disabled.\nClick again to enable it.")
		}
		else
		{
			TacticalTips[client]=true
			PrintHintText(client,"Tips is enabled.\nClick again to disable it.")
		}
	}
}

public Action:RemoveRadar(Handle:timer, any:client)
{	
	if (!IsValidEntity(client))
		return
	SetEntProp(client, Prop_Send, "m_iHideHUD", 1 << 12)
}

public Action:ShowGameTips(Handle:timer, any:client)
{
	if (!IsClientConnected(client) || !IsClientInGame(client))
	{
		GameTipsLoop[client]=0
		GameTipsHandle[client]=INVALID_HANDLE
		return Plugin_Stop
	}
	if (!TacticalTips[client])
	{
		GameTipsLoop[client]=0
		GameTipsHandle[client]=INVALID_HANDLE
		return Plugin_Stop
	}
	switch (GameTipsLoop[client])
	{
		case 3:
		{
			if (GetClientTeam(client)==CS_TEAM_CT)
				PrintHintText(client,"Eliminate all Ghosts!\nPress <font color='#ff0000'>G</font> to select your guns.")
			else if (GetClientTeam(client)==CS_TEAM_T)
				PrintHintText(client,"Eliminate all Human!\n<font color='#ff0000'>Sneak attack</font> may be your best tactic.")
			GameTipsLoop[client]--
			return Plugin_Continue
		}
		case 2:
		{
			if (GetClientTeam(client)==CS_TEAM_CT)
			{
				switch (GetRandomInt(0,1))
				{
					case 0:
						PrintHintText(client,"<font color='#00ff00'>Tactical tips:</font>\nHold <font color='#ff0000'>shift</font> to turn your flashlight on.")
					case 1:
						PrintHintText(client,"<font color='#00ff00'>Tactical tips:</font>\n<font color='#ff0000'>Taser</font> can eliminate ghosts easyly.")
				}
			}
			else if (GetClientTeam(client)==CS_TEAM_T)
			{
				switch (GetRandomInt(0,1))
				{
					case 0:
						PrintHintText(client,"<font color='#00ff00'>Tactical tips:</font>\nAvoid sun light and flashlights.")
					case 1:
						PrintHintText(client,"<font color='#00ff00'>Tactical tips:</font>\nTry to disrupt your enemies so your teammates can attack them easier.")
				}
			}
			GameTipsLoop[client]--
			return Plugin_Continue
		}
		case 1:
		{
			if (GetClientTeam(client)==CS_TEAM_CT)
			{
				switch (GetRandomInt(0,1))
				{
					case 0:
						PrintHintText(client,"<font color='#00ff00'>Tactical tips:</font>\nYou can keep ghosts visible and slow them down by shoting them.")
					case 1:
						PrintHintText(client,"<font color='#00ff00'>Tactical tips:</font>\nDon't forget to save your ammo.")
				}
			}
			else if (GetClientTeam(client)==CS_TEAM_T)
			{
				switch (GetRandomInt(0,1))
				{
					case 0:
						PrintHintText(client,"<font color='#00ff00'>Tactical tips:</font>\n<font color='#ff0000'>Stealth</font> can keep you invisible until you attack your enemies or take damage from them.")
					case 1:
						PrintHintText(client,"<font color='#00ff00'>Tactical tips:</font>\n<font color='#ff0000'>Bullet-proof</font> can keep you safe from all guns but would be neutralized if you took too much damage.")
				}
			}
			GameTipsLoop[client]--
			return Plugin_Continue
		}
		default:
		{
			PrintHintText(client,"Click <font color='#ff0000'>Dot</font> to disable / enable Tips.")
			GameTipsLoop[client]=0
			GameTipsHandle[client]=INVALID_HANDLE
			return Plugin_Stop
		}
	}
	return Plugin_Stop
}

public InitializeClientData(client)
{
	FavPri[client]=-1
	FavSec[client]=-1
	StealthTimeRemain[client]=0
	FlashlightUsing[client]=false
	GameTipsLoop[client]=0
	if (GameTipsHandle[client]!=INVALID_HANDLE)
	{
		KillTimer(GameTipsHandle[client])
		GameTipsHandle[client]=INVALID_HANDLE
	}
	TacticalTips[client]=true
}

public Action:ShowGunMenuPri(client,args)
{
	FavPri[client]=-1
	new Handle:HandleGunMenuPri = CreateMenu(GunMenuPri)
	SetMenuTitle(HandleGunMenuPri, "Select a primary weapon:")
	for (new i=0;i<21;i++)
		AddMenuItem(HandleGunMenuPri, "", WpnCnNamePri[i])
	SetMenuExitButton(HandleGunMenuPri, true)
	DisplayMenu(HandleGunMenuPri, client, 20)
	return Plugin_Handled
}

public GunMenuPri(Handle:HandleGunMenuPri, MenuAction:action, param1, param2)
{
	new client=param1
	new choice=param2
	if (action == MenuAction_Select)
	{
		FavPri[client]=choice
		ClientCommand(client,"hc_gun_menu_sec")
	}
	else if (action == MenuAction_End)
		CloseHandle(HandleGunMenuPri);
}

public Action:ShowGunMenuSec(client,args)
{
	FavSec[client]=-1
	new Handle:HandleGunMenuSec = CreateMenu(GunMenuSec)
	SetMenuTitle(HandleGunMenuSec, "Select a secondary weapon:")
	for (new i=0;i<10;i++)
		AddMenuItem(HandleGunMenuSec, "", WpnCnNameSec[i])
	SetMenuExitButton(HandleGunMenuSec, true)
	DisplayMenu(HandleGunMenuSec, client, 20)
	return Plugin_Handled
}

public GunMenuSec(Handle:HandleGunMenuSec, MenuAction:action, param1, param2)
{
	new client=param1
	new choice=param2
	if (action == MenuAction_Select)
	{
		FavSec[client]=choice
		CS_RespawnPlayer(client)
	}
	else if (action == MenuAction_End)
		CloseHandle(HandleGunMenuSec);
}

public RemoveGuns(client,slot)
{
	if (slot==1)
	{
		new WpnId = GetPlayerWeaponSlot(client,_:SlotPrimary)
		if (WpnId!=-1)
		{
			RemovePlayerItem(client, WpnId)
			AcceptEntityInput(WpnId, "Kill")
		}
	}
	else if (slot==2)
	{
		new WpnId = GetPlayerWeaponSlot(client,_:SlotSecondary)
		if (WpnId!=-1)
		{
			RemovePlayerItem(client, WpnId)
			AcceptEntityInput(WpnId, "Kill")
		}
	}
	else if (slot==3)
	{
		new WpnId = GetPlayerWeaponSlot(client,_:SlotKnife)
		if (WpnId!=-1)
		{
			RemovePlayerItem(client, WpnId)
			AcceptEntityInput(WpnId, "Kill")
		}
	}
	else if (slot==4)
	{
		new WpnId = GetPlayerWeaponSlot(client,_:SlotGrenade)
		while (WpnId!=-1)
		{
			RemovePlayerItem(client, WpnId)
			AcceptEntityInput(WpnId, "Kill")
			WpnId = GetPlayerWeaponSlot(client,_:SlotGrenade)
		}
	}
}

public Action:CheckStealth(Handle:timer, any:client)
{
	if (!IsClientConnected(client) || !IsClientInGame(client) || !IsPlayerAlive(client))
	{
		StealthTimeRemain[client]=0
		return Plugin_Stop
	}
	if (StealthTimeRemain[client]>0)
	{
		StealthTimeRemain[client]--
		if (StealthTimeRemain[client]>1000)
			PrintHintText(client,"<font color='#ff0000'>Stealth</font> and <font color='#ff0000'>Bullet-proof</font> are both neutralized!\n<font color='#ff0000'>%d.%d</font>seconds to resume.",StealthTimeRemain[client]/10,StealthTimeRemain[client]%10)
		else
			PrintHintText(client,"<font color='#ff0000'>Stealth</font> is neutralized!\n<font color='#ff0000'>%d.%d</font>seconds to resume.",StealthTimeRemain[client]/10,StealthTimeRemain[client]%10)
		return Plugin_Continue
	}
	else
	{
		SetEntityRenderFx(client,RENDERFX_DISTORT)
		SetClientSpeed(client,1.0)
		PrintHintText(client,"You are invisible now.")
		return Plugin_Stop
	}
}

public Action:OnTakeDamage(Victim, &Attacker, &Inflictor, &Float:Damage, &Damagetype)
{
	if (!(0<Attacker<MAXPLAYERS) || !(0<Victim<MAXPLAYERS))
		return Plugin_Continue
	new Vteam=GetClientTeam(Victim)
	new Ateam
	if (IsValidEntity(Attacker))
		Ateam=GetClientTeam(Attacker)
	if (Ateam==Vteam)
		return Plugin_Handled
	if (Ateam==CS_TEAM_CT && Vteam==CS_TEAM_T)
	{
		new IntDamage=RoundFloat(Damage)
		if (Damagetype==64 || Damagetype==8 || Damagetype==4352 || Damagetype==4100)
		{
			if (GetClientHealth(Victim)<=IntDamage)
				return Plugin_Continue
			else if (StealthTimeRemain[Victim]==0)
			{
				StealthTimeRemain[Victim]=StealthTimeRemain[Victim]+IntDamage
				SetEntityRenderFx(Victim,RENDERFX_EXPLODE)
				CreateTimer(0.1,CheckStealth,Victim,TIMER_REPEAT)
				SetClientSpeed(Victim,0.7)
				if (StealthTimeRemain[Victim]>1000)
					PrintHintText(Attacker,"Target spotted!\nKeep shoting, don't stop!")
				else
					PrintHintText(Attacker,"Target spotted!\nUse your <font color='#ff0000'>Taser</font> to eliminate him!")
				return Plugin_Continue
			}
			else
			{
				StealthTimeRemain[Victim]=StealthTimeRemain[Victim]+IntDamage
				if (StealthTimeRemain[Victim]>1000)
					PrintHintText(Attacker,"Target spotted!\nKeep shoting, don't stop!")
				else
					PrintHintText(Attacker,"Target spotted!\nUse your <font color='#ff0000'>Taser</font> to eliminate him!")
				return Plugin_Continue
			}
		}
		else if ((Damagetype==4098 || Damagetype==1073745922))
		{
			if (GetClientHealth(Victim)<=IntDamage && StealthTimeRemain[Victim]>1000)
				return Plugin_Continue
			if (StealthTimeRemain[Victim]==0)
			{
				StealthTimeRemain[Victim]=StealthTimeRemain[Victim]+IntDamage
				SetEntityRenderFx(Victim,RENDERFX_EXPLODE)
				CreateTimer(0.1,CheckStealth,Victim,TIMER_REPEAT)
				SetClientSpeed(Victim,0.7)
				if (StealthTimeRemain[Victim]>1000)
					PrintHintText(Attacker,"Target spotted!\nKeep shoting, don't stop!")
				else
					PrintHintText(Attacker,"Target spotted!\nUse your <font color='#ff0000'>Taser</font> to eliminate him!")
			}
			else
			{
				StealthTimeRemain[Victim]=StealthTimeRemain[Victim]+IntDamage
				if (StealthTimeRemain[Victim]>1000)
					PrintHintText(Attacker,"Target spotted!\nKeep shoting, don't stop!")
				else
					PrintHintText(Attacker,"Target spotted!\nUse your <font color='#ff0000'>Taser</font> to eliminate him!")
			}	
			if (StealthTimeRemain[Victim]>1000)
				return Plugin_Continue
			else
				return Plugin_Handled
		}
	}
	else if (Ateam==CS_TEAM_T && Vteam==CS_TEAM_CT)
	{
		new IntDamage=RoundFloat(Damage)
		if (StealthTimeRemain[Attacker]==0)
		{
			StealthTimeRemain[Attacker]=StealthTimeRemain[Attacker]+IntDamage
			SetEntityRenderFx(Attacker,RENDERFX_EXPLODE)
			CreateTimer(0.1,CheckStealth,Attacker,TIMER_REPEAT)
			SetClientSpeed(Attacker,0.7)
		}
		else
			StealthTimeRemain[Attacker]=StealthTimeRemain[Attacker]+IntDamage
		Damage=Damage*2
		return Plugin_Changed
	}
	return Plugin_Continue
}

public SetClientSpeed(client,Float:speed)
{
	if (!IsValidEntity(client))
		return
	SetEntPropFloat(client, Prop_Send, "m_flLaggedMovementValue",speed)
}
