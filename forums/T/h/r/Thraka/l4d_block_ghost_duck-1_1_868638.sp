/* Plugin Template generated by Pawn Studio */

#include <sourcemod>

#define CVAR_FLAGS FCVAR_PLUGIN
#define PLUGIN_VERSION "1.1"
#define INFECTEDTEAM 3
#define GHOST_STATE_BLOCKED 1024

public Plugin:myinfo = 
{
	name = "[L4D] Block Ghost Duck",
	author = "Thraka",
	description = "Forces a player (on spawn) to duck-unduck. Prevents ghosts from using exploits.",
	version = PLUGIN_VERSION,
	url = "http://forums.alliedmods.net/showthread.php?p=868638"
}

public OnPluginStart()
{
	CreateConVar("l4d_ghost_duck_block_ver", PLUGIN_VERSION, "Version of the ghost block plugin.", FCVAR_PLUGIN|FCVAR_SPONLY|FCVAR_NOTIFY);
}

public Action:OnPlayerRunCmd(client, &buttons, &impulse, Float:vel[3], Float:angles[3], &weapon)
{
	if (GetClientTeam(client) == INFECTEDTEAM)
	{
		// Check for is a ghost
		new offset = FindSendPropInfo("CTerrorPlayer", "m_isGhost");
		if (offset > 0)
		{
			if (GetEntData(client, offset, 1))
			{	
				// Check for ghost blocked
				offset = FindSendPropInfo("CTerrorPlayer", "m_ghostSpawnState");
				if (offset > 0)
				{
					if (GetEntData(client, offset, 4) & GHOST_STATE_BLOCKED)
					{
						// Block +duck
						buttons &= ~IN_DUCK;
						
						// We must return Plugin_Continue to let the changes be processed.
						// Otherwise, we can return Plugin_Handled to block the commands
					}

				}

			}

		}

	}
	
	return Plugin_Continue;
}