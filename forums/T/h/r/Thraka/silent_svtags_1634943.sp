/* Plugin Template generated by Pawn Studio */

#include <sourcemod>

public Plugin:myinfo = 
{
	name = "Silence sv_tags and cvar changes",
	author = "Thraka",
	description = "Makes the sv_tags cvar silent. Adds sm_scvar to silently change a cvar.",
	version = "1.0",
	url = "None"
}

public OnPluginStart()
{
	new Handle:cvar= FindConVar("sv_tags");
	new flags = GetConVarFlags(cvar);
	SetConVarFlags(cvar, flags & ~FCVAR_NOTIFY);
	
	RegAdminCmd("sm_scvar", Cmd_SilentCvar, ADMFLAG_GENERIC, "Executes a cvar change silently");
}

public Action:Cmd_SilentCvar(client, args) 
{
	if (GetCmdArgs() == 2)
	{
		new String:cvarName[50];
		new String:cvarValue[200];
		new Handle:pack;
		
		GetCmdArg(1, cvarName, 50);
		GetCmdArg(2, cvarValue, 200);
		
		new Handle:cvar= FindConVar(cvarName);
		new flags = GetConVarFlags(cvar);
		
		if (flags & FCVAR_NOTIFY)
			SetConVarFlags(cvar, flags & ~FCVAR_NOTIFY);

		ServerCommand("sm_cvar %s %s", cvarName, cvarValue);
		
		CreateDataTimer(0.3, Timer_ResetCvarFlags, pack, TIMER_FLAG_NO_MAPCHANGE); 
		WritePackCell(pack, cvar);
		WritePackCell(pack, flags);
	}
	else
		ReplyToCommand(client, "Format for a silent cvar is sm_scvar name value");
		
	return Plugin_Handled;
}

public Action:Timer_ResetCvarFlags(Handle:timer, any:pack)
{
	ResetPack(pack);
	new Handle:cvar = ReadPackCell(pack);
	new flags = ReadPackCell(pack);

	SetConVarFlags(cvar, flags);
	
	return Plugin_Stop;
}