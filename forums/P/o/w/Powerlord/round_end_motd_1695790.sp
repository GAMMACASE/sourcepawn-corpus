/* Plugin Template generated by Pawn Studio */

#pragma semicolon 1
#include <sourcemod>

new Handle:g_Cvar_obBonusTime = INVALID_HANDLE;
new Handle:g_Cvar_dodBonusTime = INVALID_HANDLE;

public Plugin:myinfo = 
{
	name = "Round End MOTD",
	author = "Powerlord",
	description = "Show the MOTD at the end of the round.",
	version = "1.0",
	url = "https://forums.alliedmods.net/showthread.php?t=163598"
}

public OnPluginStart()
{
	// Most games
	HookEventEx("round_end", Event_RoundEnd);
	// TF2
	HookEventEx("teamplay_round_win", Event_RoundEnd);
	
	g_Cvar_obBonusTime = FindConVar("mp_bonusroundtime");
	g_Cvar_dodBonusTime = FindConVar("dod_bonusroundtime");
}

public Event_RoundEnd(Handle:event, const String:name[], bool:dontBroadcast)
{
	new Float:bonusTime = 0.0;
	if (g_Cvar_obBonusTime != INVALID_HANDLE)
	{
		bonusTime = GetConVarFloat(g_Cvar_obBonusTime);
	}
	else if (g_Cvar_dodBonusTime != INVALID_HANDLE)
	{
		bonusTime = GetConVarFloat(g_Cvar_dodBonusTime);
	}
	
	CreateTimer(bonusTime, Timer_MOTD, INVALID_HANDLE, TIMER_FLAG_NO_MAPCHANGE);
}

public Action:Timer_MOTD(Handle:timer)
{
	for (new i = 1; i <= MaxClients; i++)
	{
		if (IsClientInGame(i) && !IsFakeClient(i))
		{
			// Taken from basetriggers.sp
			ShowMOTDPanel(i, "Message Of The Day", "motd", MOTDPANEL_TYPE_INDEX);
		}
	}
	return Plugin_Continue;
}